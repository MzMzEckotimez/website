<h2 id="what-is">What is</h2>
<p>Bundle is a small framework for bundling together LuaJIT, Lua modules, Lua/C modules, DynASM/Lua modules, C libraries, and other static assets into a single fat executable. In its default configuration, it assumes luapower's <a href="/building">toolchain</a> and <a href="/get-involved">directory layout</a> and it works on Windows, Linux and OSX, x86 and x64.</p>
<h2 id="usage">Usage</h2>
<pre><code>mgit bundle options...

  -o  --output FILE                  Output executable (required)

  -m  --modules &quot;FILE1 ...&quot;|--all|-- Lua (or other) modules to bundle [1]
  -a  --alibs &quot;LIB1 ...&quot;|--all|--    Static libs to bundle            [2]
  -d  --dlibs &quot;LIB1 ...&quot;|--          Dynamic libs to link against     [3]
  -f  --frameworks &quot;FRM1 ...&quot;        Frameworks to link against (OSX) [4]

  -M  --main MODULE                  Module to run on start-up

  -m32                               Compile for 32bit (OSX)
  -z  --compress                     Compress the executable (needs UPX)
  -w  --no-console                   Hide console (Windows)
  -w  --no-console                   Make app bundle (OSX)
  -i  --icon FILE.ico                Set icon (Windows)
  -i  --icon FILE.png                Set icon (OSX; requires -w)

  -ll --list-lua-modules             List Lua modules
  -la --list-alibs                   List static libs (.a files)

  -C  --clean                        Ignore the object cache

  -v  --verbose                      Be verbose
  -h  --help                         Show this screen

 Passing -- clears the list of args for that option, including implicit args.

 [1] .lua, .c and .dasl are compiled, other files are added as blobs.

 [2] implicit static libs:           luajit
 [3] implicit dynamic libs:
 [4] implicit frameworks:            ApplicationServices</code></pre>
<h3 id="examples">Examples</h3>
<pre><code># full bundle: all Lua modules plus all static libraries
mgit bundle -a --all -m --all -M main -o fat.exe

# minimal bundle: two Lua modules, one static lib, one blob
mgit bundle -a sha2 -m &#39;sha2 main media/bmp/bg.bmp&#39; -M main -o lean.exe

# luajit frontend with built-in luasocket support, no main module
mgit bundle -a &#39;socket_core mime_core&#39; -m &#39;socket mime ltn12 socket/*.lua&#39; -o luajit.exe

# run the unit tests
mgit bundle-test</code></pre>
<h2 id="how-it-works">How it works</h2>
<p>The core of it is a slightly modifed LuaJIT frontend which adds two additional loaders at the end of the <code>package.loaders</code> table, enabling <code>require()</code> to load modules embedded in the executable when they are not found externally. <code>ffi.load()</code> is also modified to return <code>ffi.C</code> if the requested library is not found, allowing embedded C symbols to be used instead. Assets can be loaded with <code>bundle.load(filename)</code> (see below), subject to the same policy: load the embedded asset if the corresponding file is not present in the filesystem.</p>
<p>This allows mixed deployments where some modules and assets are bundled inside the exe and some are left outside, with no changes to the code and no rebundling needed. External modules always take precedence over embedded ones, allowing partial upgrades to the original executable without the need for a rebuild. Finally, one of the modules (embedded or not) can be specified to run instead of the usual REPL, effectively enabling single-executable app deployment for pure Lua apps with no glue C code needed.</p>
<h3 id="components">Components</h3>
<h4 id="mgitbundle.sh">.mgit/bundle.sh</h4>
<p>The bundler script: compiles and links modules to create a fat executable.</p>
<blockquote>
<p>The reason the script is hidden inside the .mgit dir is to allow you to use the same command <code>mgit bundle</code> on all platforms. In particular, mgit will drive the script using Git bash on Windows, if git is in your PATH. You can run the script directly without mgit of course but always run it from the root directory like this: <code>.mgit/bundle.sh</code> or move it there.</p>
</blockquote>
<h4 id="csrcbundleluajit.c">csrc/bundle/luajit.c</h4>
<p>The standard LuaJIT frontend, slightly modified to run stuff from <code>bundle.c</code>.</p>
<h4 id="csrcbundlebundle.c">csrc/bundle/bundle.c</h4>
<p>The bundle loader (C part):</p>
<ul>
<li>installs require() loaders on startup for loading embedded Lua and C modules</li>
<li>fills <code>_G.arg</code> with command-line args</li>
<li>sets <code>_G.arg[-1]</code> to the name of the main script (<code>-M</code> option)</li>
<li>calls <code>require'bundle_loader'</code>
<ul>
<li>(which means bundle_loader itself can be upgraded without a rebuild)</li>
</ul></li>
</ul>
<h4 id="bundle_loader.lua">bundle_loader.lua</h4>
<p>The bundle loader (Lua part):</p>
<ul>
<li>sets <code>package.path</code> and <code>package.cpath</code> to load modules relative to the exe's dir</li>
<li>overrides <code>ffi.load</code> to return <code>ffi.C</code> when a library is not found</li>
<li>loads the main module, if any, per <code>arg[-1]</code></li>
<li>falls back to LuaJIT REPL if there's no main module</li>
</ul>
<h4 id="bundle.lua">bundle.lua</h4>
<p>Optional module for loading embedded binary files: contains the function <code>bundle.load(filename) -&gt; string</code>.</p>
<h2 id="search-paths">Search paths</h2>
<p>External files are looked for relative to the executable directory, regardless of the current directory, as follows:</p>
<ul>
<li>shared library dependencies (either link-time or ffi.load-time) are searched for in $exedir</li>
<li>Lua modules are searched for in $exedir</li>
<li>Lua/C modules are searched for in $exedir/clib</li>
<li>static assets are searched for in $exedir</li>
</ul>
<h2 id="a-note-on-compression">A note on compression</h2>
<p>Compressed executables cannot be mmapped, so they have to stay in RAM fully and always. If the bundled assets are large and compressible, better results can be acheived by compressing them individually or not compressing them at all, instead of compressing the entire exe. Compression also adds up to the exe's loading time.</p>
<h2 id="licensing-restrictions">Licensing restrictions</h2>
<p>Some libraries in luapower are LGPL (check the package table on the homepage to see which). LGPL does not allow static linking on closed-source projects. IANAL, but because a bundled executable will always load the dynamic version of a bundled library if one is found in the directory of the exe, it could be argued that the behavior complies with the intention of LGPL to provide a way for the user to switch the said library.</p>
